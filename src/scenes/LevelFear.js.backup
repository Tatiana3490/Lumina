import { Scene } from 'phaser';
import { Player } from '../objects/Player';
import { HUD } from '../objects/HUD';

export class LevelFear extends Scene {
    constructor() {
        super('LevelFear');
    }

    create() {
        // Enable lights
        this.lights.enable().setAmbientColor(0x030803); // Más oscuro

        // Background with forest image - full screen
        const bg = this.add.image(0, 0, 'bg_fear').setOrigin(0, 0);
        bg.displayWidth = 2500;
        bg.displayHeight = 2000;
        bg.setScrollFactor(0.2);
        bg.setAlpha(0.5);

        // Level Text
        this.add.text(50, 50, 'Level 2: The Whispering Maze', { fontSize: '24px', fill: '#88ffaa' })
            .setScrollFactor(0);

        // --- GROUPS ---
        this.walls = this.physics.add.staticGroup();
        this.fragments = this.physics.add.staticGroup();
        this.shadows = this.physics.add.group({ allowGravity: false, immovable: true });

        // --- LABERINTO COMPLEJO ---
        // Paredes exteriores
        this.createWall(0, 0, 2500, 50); // Top
        this.createWall(0, 1950, 2500, 50); // Bottom
        this.createWall(0, 0, 50, 2000); // Left
        this.createWall(2450, 0, 50, 2000); // Right

        // Laberinto interior - MUCHO MÁS COMPLEJO
        // Zona 1: Entrada y primer desafío
        this.createWall(200, 200, 50, 400);
        this.createWall(200, 200, 400, 50);
        this.createWall(350, 350, 50, 300);
        this.createMovingShadow(250, 400, 80);

        // Zona 2: Pasillo estrecho
        this.createWall(500, 100, 50, 600);
        this.createWall(650, 300, 50, 400);
        this.createMovingShadow(575, 450, 60);

        // Zona 3: Sala con múltiples sombras
        this.createWall(800, 200, 50, 500);
        this.createWall(800, 200, 300, 50);
        this.createWall(1050, 200, 50, 300);
        this.createMovingShadow(900, 350, 100);
        this.createMovingShadow(900, 500, 80);

        // Zona 4: Corredor zigzag
        this.createWall(1200, 100, 50, 400);
        this.createWall(1350, 300, 50, 500);
        this.createWall(1200, 700, 200, 50);
        this.createMovingShadow(1275, 500, 60);

        // Zona 5: Laberinto dentro del laberinto
        this.createWall(1500, 200, 50, 300);
        this.createWall(1500, 200, 300, 50);
        this.createWall(1750, 200, 50, 400);
        this.createWall(1650, 350, 50, 250);
        this.createMovingShadow(1575, 400, 70);
        this.createMovingShadow(1700, 300, 50);

        // Zona 6: Pasillo final trampa
        this.createWall(1900, 100, 50, 700);
        this.createWall(2050, 400, 50, 600);
        this.createMovingShadow(1975, 600, 60);
        this.createMovingShadow(1975, 300, 80);

        // Paredes adicionales para hacer más complejo
        this.createWall(400, 800, 300, 50);
        this.createWall(900, 900, 50, 400);
        this.createWall(1200, 1200, 400, 50);
        this.createWall(1800, 1000, 50, 500);

        // Fragmentos muy escondidos
        this.createFragment(300, 350);
        this.createFragment(925, 400);
        this.createFragment(1275, 600);
        this.createFragment(1700, 450);

        // Goal
        this.goal = this.physics.add.image(2200, 1700, 'portal');
        this.goal.setPipeline('Light2D');
        this.goal.setTint(0x00ff00);
        this.goal.body.allowGravity = false;
        this.goal.body.immovable = true;

        // Goal Particles
        const particles = this.add.particles(0, 0, 'firefly', {
            speed: 100,
            scale: { start: 0.5, end: 0 },
            blendMode: 'ADD',
            lifespan: 1000,
            gravityY: -100,
            quantity: 2,
            emitting: true,
            tint: 0x55ff55
        });
        particles.startFollow(this.goal);

        // Player
        this.player = new Player(this, 100, 600);

        // --- COLLIDERS ---
        this.physics.add.collider(this.player, this.walls);
        this.physics.add.overlap(this.player, this.fragments, this.collectFragment, null, this);
        this.physics.add.overlap(this.player, this.shadows, this.hitShadow, null, this);
        this.physics.add.overlap(this.player, this.goal, this.reachGoal, null, this);

        // Camera
        this.cameras.main.setBounds(0, 0, 2500, 2000);
        this.physics.world.setBounds(0, 0, 2500, 2000);
        this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
        this.cameras.main.setZoom(1.4); // Más zoom = más claustrofóbico

        // Create HUD
        this.hud = new HUD(this, 4); // 4 fragments total
        this.hud.updateEnergy(this.player.currentLight, this.player.maxLight);
    }

    createWall(x, y, width, height) {
        const wall = this.add.rectangle(x, y, width, height, 0x1a3a1a);
        wall.setOrigin(0, 0);
        this.physics.add.existing(wall, true);
        wall.setPipeline('Light2D');
        this.walls.add(wall);
    }

    createFragment(x, y) {
        const f = this.fragments.create(x, y, 'fragment');
        f.setPipeline('Light2D');
        this.tweens.add({
            targets: f,
            y: y - 10,
            duration: 1500,
            yoyo: true,
            repeat: -1
        });
    }

    createMovingShadow(x, y, distance) {
        const s = this.shadows.create(x, y, 'shadow');
        s.setPipeline('Light2D');

        this.tweens.add({
            targets: s,
            y: y + distance,
            duration: 2000,
            yoyo: true,
            repeat: -1,
            ease: 'Sine.easeInOut'
        this.hud.updateEnergy(player.currentLight, player.maxLight);

            if(isDead) {
                this.cameras.main.shake(500, 0.02);
                this.time.delayedCall(500, () => {
                    this.scene.restart();
                });
            } else {
                if(player.x < shadow.x) {
            player.setVelocityX(-300);
        } else {
            player.setVelocityX(300);
        }
        player.setVelocityY(-300);
    }
}

reachGoal(player, goal) {
    if (this.fragments.countActive(true) > 0) {
        const remaining = this.fragments.countActive(true);
        const msg = this.add.text(player.x, player.y - 50, `Collect ${remaining} more lights!`, {
            fontSize: '20px',
            fill: '#88ffaa',
            stroke: '#000',
            strokeThickness: 4
        }).setOrigin(0.5);

        this.tweens.add({
            targets: msg,
            y: player.y - 80,
            alpha: 0,
            duration: 1500,
            onComplete: () => msg.destroy()
        });
        return;
    }

    this.physics.pause();
    this.add.text(player.x, player.y - 100, 'You Escaped!', {
        fontSize: '48px',
        fill: '#88ffaa',
        stroke: '#000',
        strokeThickness: 6
    }).setOrigin(0.5);

    this.tweens.add({
        targets: player,
        angle: 360,
        duration: 1000,
        onComplete: () => {
            this.time.delayedCall(2000, () => {
                this.scene.start('LevelHope');
            });
        }
    });
}
}
